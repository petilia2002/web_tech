<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Роли — меню редактирования</title>
    <style>
      :root {
        --bg: #f4f7fb;
        --card: #fff;
        --text: #1f2937;
        --muted: #6b7280;
        --primary: #0d6efd;
        --primary-600: #0b5ed7;
        --gray: #6c757d;
        --border: #e5e7eb;
        --soft-blue: #e9f2ff;
        --shadow: 0 10px 30px rgba(13, 110, 253, 0.08),
          0 6px 12px rgba(0, 0, 0, 0.06);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial,
          "Noto Sans", "Helvetica Neue", sans-serif;
        color: var(--text);
        background: radial-gradient(
            1200px 600px at -10% -10%,
            #eaf1ff 0%,
            transparent 60%
          ),
          radial-gradient(900px 500px at 110% -20%, #eaf1ff 0%, transparent 60%),
          var(--bg);
      }
      .container {
        max-width: 980px;
        margin: 48px auto;
        padding: 0 20px;
      }
      .card {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .card__header {
        padding: 24px 28px;
        background: linear-gradient(180deg, var(--soft-blue), #ffffff00 80%);
      }
      .title {
        margin: 0 0 6px;
        font-size: clamp(22px, 2.6vw, 28px);
      }
      .subtitle {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }
      .card__body {
        padding: 20px 28px 28px;
      }
      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        margin-bottom: 14px;
      }
      .toolbar input,
      .toolbar select {
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
        outline: none;
      }
      .toolbar input:focus,
      .toolbar select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.12);
      }
      .btn {
        appearance: none;
        border: 0;
        cursor: pointer;
        padding: 10px 14px;
        border-radius: 10px;
        font-weight: 600;
      }
      .btn-primary {
        background: var(--primary);
        color: #fff;
      }
      .btn-primary:hover {
        background: var(--primary-600);
      }
      .btn-outline {
        background: #fff;
        color: var(--primary);
        border: 1px solid rgba(13, 110, 253, 0.35);
      }
      .muted {
        color: var(--muted);
        font-size: 12px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
      }
      thead th {
        text-align: left;
        font-weight: 700;
        font-size: 14px;
        color: #374151;
        background: #f8fafc;
        border-bottom: 1px solid var(--border);
        padding: 12px 14px;
      }
      tbody td {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
      }
      tbody tr:hover {
        background: #f6faff;
      }
      .badge {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
      }
      .on {
        background: #e7f7ee;
        color: #0a7a2a;
      }
      .off {
        background: #fdeaea;
        color: #b42318;
      }
      .pagination {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: flex-end;
        margin-top: 12px;
      }
      .link {
        color: var(--primary);
        text-decoration: none;
        font-weight: 600;
      }
      .link:hover {
        text-decoration: underline;
      }
      #topbar {
        font-family: "Roboto", sans-serif;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 30px;
        border-bottom: 1px solid #ddd;
      }
      .bar_content {
        display: flex;
        column-gap: 60px;
      }
      .navbar {
        display: flex;
        column-gap: 20px;
      }
      .navbar a {
        color: #000;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div id="topbar">
      <div class="bar_content">
        <div><strong>Web-приложение</strong></div>
        <div class="navbar">
          <a href="/login">Вход</a>
          <a href="/users">Пользователи</a>
          <a href="/roles">Роли</a>
          <a href="/protected">Приветствие</a>
          <a href="/stats">Статистика</a>
          <a href="/companies">Компании</a>
          <a href="/cart">Корзина</a>
        </div>
      </div>
      <div id="user-area">
        <!-- сюда вставим "Вы вошли как ... / Выйти" -->
        <span id="who"></span>
        <span id="sep" style="display: none"> | </span>
        <a href="#" id="logout" style="display: none">Выйти</a>
      </div>
    </div>
    <div class="container">
      <div class="card">
        <div class="card__header">
          <h1 class="title">Роли</h1>
          <p class="subtitle">Справочник ролей и переход к редактированию</p>
        </div>
        <div class="card__body">
          <div class="toolbar">
            <input id="q" type="text" placeholder="Поиск по названию" />
            <select id="status">
              <option value="all" selected>Все статусы</option>
              <option value="enabled">Включено</option>
              <option value="disabled">Выключено</option>
            </select>
            <select id="order">
              <option value="id">Сортировка: ID</option>
              <option value="name">Сортировка: Название</option>
              <option value="status">Сортировка: Статус</option>
            </select>
            <select id="dir">
              <option value="asc">По возрастанию</option>
              <option value="desc">По убыванию</option>
            </select>
            <select id="limit">
              <option value="10">10 на страницу</option>
              <option value="25" selected>25 на страницу</option>
              <option value="50">50 на страницу</option>
            </select>
            <button
              id="apply"
              class="btn btn-outline"
              title="Повторно загрузить список ролей с учётом фильтров"
            >
              Обновить список
            </button>

            <a class="btn btn-primary" href="/role-edit?create=1"
              >Создать роль</a
            >
            <div
              style="align-self: end; display: flex; gap: 8px; flex-wrap: wrap"
            >
              <a href="/users" class="btn btn-primary">← К пользователям</a>
            </div>
            <span class="muted" id="meta"></span>
          </div>

          <div style="overflow: auto; border-radius: 12px">
            <table id="tbl">
              <thead>
                <tr>
                  <th style="width: 80px">ID</th>
                  <th>Название</th>
                  <th style="width: 140px">Статус</th>
                  <th style="width: 160px">Действия</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="4" class="muted">Загрузка…</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="pagination">
            <button id="prev" class="btn btn-outline">Назад</button>
            <button id="next" class="btn btn-outline">Вперёд</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function fetchMe() {
        try {
          const res = await fetch("/auth/me", {
            credentials: "same-origin",
          });
          if (res.status === 401) {
            // не авторизован — редирект на страницу логина
            window.location.href = "/login";
            return null;
          }
          if (!res.ok) {
            throw new Error("Ошибка при получении сессии");
          }
          return await res.json();
        } catch (err) {
          console.error(err);
          // на ошибку — редирект на логин (безопаснее)
          window.location.href = "/login";
          return null;
        }
      }

      async function doLogout() {
        try {
          // POST logout
          await fetch("/auth/logout", {
            method: "POST",
            credentials: "same-origin",
          });
        } catch (e) {
          console.warn("Logout request failed", e);
        } finally {
          window.location.href = "/login?logged_out=1";
        }
      }
      const state = {
        q: "",
        status: "all",
        offset: 0,
        limit: 25,
        order: "id",
        dir: "asc",
        total: 0,
      };

      const qEl = document.getElementById("q");
      const statusEl = document.getElementById("status");
      const orderEl = document.getElementById("order");
      const dirEl = document.getElementById("dir");
      const limitEl = document.getElementById("limit");
      const applyBtn = document.getElementById("apply");
      const metaEl = document.getElementById("meta");
      const tblBody = document.querySelector("#tbl tbody");
      const prevBtn = document.getElementById("prev");
      const nextBtn = document.getElementById("next");

      async function load() {
        const params = new URLSearchParams({
          q: state.q,
          status: state.status,
          offset: state.offset,
          limit: state.limit,
          order: state.order,
          direction: state.dir,
        });
        try {
          tblBody.innerHTML =
            '<tr><td colspan="4" class="muted">Загрузка…</td></tr>';
          const r = await fetch("/api/roles/list?" + params.toString());
          const data = await r.json();
          state.total = data.total || 0;
          renderRows(data.items || []);
          renderMeta();
        } catch (e) {
          tblBody.innerHTML =
            '<tr><td colspan="4" class="muted">Ошибка загрузки</td></tr>';
        }
      }

      function renderRows(items) {
        if (!items.length) {
          tblBody.innerHTML =
            '<tr><td colspan="4" class="muted">Ничего не найдено</td></tr>';
          return;
        }
        tblBody.innerHTML = "";
        for (const it of items) {
          const tr = document.createElement("tr");

          const tdId = document.createElement("td");
          tdId.textContent = it.role_id;
          const tdName = document.createElement("td");
          tdName.textContent = it.name || "";

          const tdStatus = document.createElement("td");
          const b = document.createElement("span");
          b.className = "badge " + (it.is_enabled ? "on" : "off");
          b.textContent = it.is_enabled ? "Включено" : "Выключено";
          tdStatus.appendChild(b);

          const tdAct = document.createElement("td");
          const a = document.createElement("a");
          a.className = "link";
          a.textContent = "Редактировать";
          a.href = "/role-edit?id=" + encodeURIComponent(it.role_id);
          tdAct.appendChild(a);

          tr.append(tdId, tdName, tdStatus, tdAct);
          tr.style.cursor = "pointer";
          tr.addEventListener("click", (ev) => {
            if (ev.target.tagName.toLowerCase() !== "a") {
              window.location =
                "/role-edit?id=" + encodeURIComponent(it.role_id);
            }
          });

          tblBody.appendChild(tr);
        }
      }

      function renderMeta() {
        const from = state.total ? state.offset + 1 : 0;
        const to = Math.min(state.offset + state.limit, state.total);
        metaEl.textContent = state.total
          ? `Показано ${from}–${to} из ${state.total}`
          : "0 записей";
        prevBtn.disabled = state.offset <= 0;
        nextBtn.disabled = state.offset + state.limit >= state.total;
      }

      applyBtn.addEventListener("click", () => {
        state.q = qEl.value.trim();
        state.status = statusEl.value;
        state.order = orderEl.value;
        state.dir = dirEl.value;
        state.limit = parseInt(limitEl.value, 10);
        state.offset = 0;
        load();
      });
      prevBtn.addEventListener("click", () => {
        state.offset = Math.max(0, state.offset - state.limit);
        load();
      });
      nextBtn.addEventListener("click", () => {
        state.offset = state.offset + state.limit;
        load();
      });

      // автоприменение поиска (дебаунс)
      let t = null;
      qEl.addEventListener("input", () => {
        clearTimeout(t);
        t = setTimeout(() => {
          state.q = qEl.value.trim();
          state.offset = 0;
          load();
        }, 350);
      });

      (async function init() {
        const me = await fetchMe();
        if (!me) return;

        // Показать имя и кнопку выхода
        const who = document.getElementById("who");
        const logoutLink = document.getElementById("logout");
        const sep = document.getElementById("sep");

        who.textContent = `Вы вошли как ${me.full_name || me.login}`;
        sep.style.display = "inline";
        logoutLink.style.display = "inline";
        logoutLink.onclick = function (e) {
          e.preventDefault();
          doLogout();
        };

        // Запрашиваем список пользователей
        await load();
      })();
    </script>
  </body>
</html>
